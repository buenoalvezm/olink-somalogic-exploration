# Platform Correlations

## Setup & Data
```{r}
library(readr)
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(HDAnalyzeR)
library(ggpubr)
library(stringr)
```

```{r}
# Olink -----
olink <- read_tsv("data/data_phase2_HT_bridged_curated_subset_20251031.tsv") |>
    select("DAid", "Assay", "UniProt", "Batch", "NPX", "LOD")

# Soma -----
soma_wide <- read_tsv("data/data_phase2_somalogic_curated_subset_20251031.tsv")
soma_meta <- read_tsv("data/meta_phase2_somalogic_elod_20251028.tsv")

soma <- soma_wide |>
  pivot_longer(cols = -c("DAid"), names_to = "AptName", values_to = "Value") |>
  left_join(soma_meta |> filter(Organism == "Human") |> select(AptName,eLOD, EntrezGeneSymbol), by = "AptName") |>
  rename(Assay = EntrezGeneSymbol)

rm(soma_wide)

# Sample metadata ----
sample_meta <- read_excel("data/samples_2025-10-10.xlsx") |>
  mutate(
    Disease = ifelse(Cohort == "PARD", Diagnose, Disease),
    Disease = ifelse(Disease %in% c("Healthy control", "healthy", "Control"), "Healthy", Disease),
    Disease = case_when(Disease == "Pancreatic ductal adenocarcinoma" ~ "Pancreatic cancer",
                        Diagnose == "OVC" ~  "Ovarian cancer",
                        Diagnose == "BRC" ~ "Breast cancer",
                        Diagnose == "LUNG" ~ "Lung cancer",
                        Diagnose == "CRC" ~ "Colorectal cancer",
                        Diagnose == "PRC" ~ "Prostate cancer",
                        Diagnose == "4_random" ~ "BAMSE - visit 4",
                        Diagnose == "8_random" ~ "BAMSE - visit 8",
                        Diagnose == "16_random" ~ "BAMSE - visit 16",
                        Diagnose == "24_random" ~ "BAMSE - visit 24",
                        Diagnose == "pregnancy" ~ "Pregnancy",
                        Diagnose == "PD" ~ "Parkinson's disease",
                        T ~ Disease),
    Class = case_when(Disease %in% c("Breast cancer", "Colorectal cancer", "Lung cancer", "Ovarian cancer", "Prostate cancer") ~ "Cancer",
                      Disease == "Parkinson's disease" ~ "Neurologic",
                      Cohort == "BAMS" ~ "Healthy",
                      Cohort == "PREG" ~ "Healthy",
                      Disease == "Healthy" ~ "Healthy",
                      T ~ Class)
    ) |>
  select(DAid, Cohort, Class, Disease, Age, Sex, BMI)

# Other protein imformation ----
gene_secretome <- read_csv("data/gene_secretome.csv")

protein_tiers <- read_excel("data/proteins_classified_tiers.xlsx") |>
  select(Assay = Gene, Tier = `confidence tier`) |>
  mutate(Tier = as.factor(Tier))

diff_exp_proteins <- read_tsv("data/de_diseases_olink_soma_overlapping.tsv")
```

Palettes

```{r}
pal_secreted <- c(
  "Actively secreted to blood" = "#B24F52",
  "Secreted in female reproductive system" = "#2A9D8F",
  "Unknown secreted location" = "#7C7C7C",
  "Secreted in male reproductive system" = "#A9D18E",
  "Secreted to extracellular matrix" = "#A6CEE3",
  "Secreted to digestive system" = "#264653",
  "Secreted in brain" = "#F4A5AE",
  "Secreted to other locations" = "#B89B74",
  "Digestive system" = "#264653",
  "Intracellular and Membrane" = "#457B9D",
  "Not part of the secretome annotation" = "lightgrey"
)

disease_class <- c(
  "Global" = "black",  # Add a color for Global
  "Healthy" = "#C9B28F",
  "Cardiovascular" = "#ED936B",
  "Metabolic" = "#E0C59A",
  "Cancer" = "#919FC7",
  "Neurologic" = "#7DC0A6",
  "Psychiatric" = "#7DC0A6",
  "Infection" = "#F9DA56",
  "Autoimmune" = "#DA8EC0"
)
```

Define order:

```{r}
class_order <- c("Global", "Healthy", "Cardiovascular", "Metabolic", "Cancer", "Neurologic", "Autoimmune", "Infection")
```

## Global correlation of common proteins

Select common proteins and DAids.

```{r}
common_daids <- intersect(unique(olink |> pull(DAid)), unique(soma |> pull(DAid)))
common_assays <- intersect(unique(olink |> pull(Assay)), unique(soma |> pull(Assay)))

olink <- olink |> filter(DAid %in% common_daids, Assay %in% common_assays)
soma <- soma |> filter(DAid %in% common_daids, Assay %in% common_assays)

meta <- sample_meta |> filter(DAid %in% common_daids)
```

### Global and per Disease class

```{r}
correlation <- olink |>
  inner_join(soma, by = c("DAid", "Assay")) |>
  group_by(Assay, AptName) |>
  summarise(
    correlation = if (sum(is.finite(NPX) & is.finite(Value)) > 1)
      suppressWarnings(cor(NPX, Value, method = "spearman", use = "complete.obs"))
    else
      NA_real_,
    .groups = "drop"
  ) |>
  mutate(Class = "Global")

correlation_by_class <- olink |>
  inner_join(soma, by = c("DAid", "Assay")) |>
  inner_join(meta |> select(DAid, Class), by = "DAid") |>
  group_by(Class, Assay, AptName) |>
  summarise(
    correlation = if (sum(is.finite(NPX) & is.finite(Value)) > 1)
      suppressWarnings(cor(NPX, Value, method = "spearman", use = "complete.obs"))
    else
      NA_real_,
    .groups = "drop"
  )

combined_correlation <- bind_rows(correlation, correlation_by_class) |>
  mutate(Class = factor(Class, levels = class_order))

ggplot(combined_correlation, aes(x = correlation, color = Class)) +
  geom_density(na.rm = TRUE, size = 0.7) +
  scale_color_manual(values = disease_class, na.value = "black") +
  labs(x = "Spearman correlation (Olink vs Soma)", y = "Density", color = "Class") +
  coord_cartesian(xlim = c(-1, 1)) +
  theme_hd()

ggsave("results/platform_corr_combined_density.png", width = 8, height = 6)

median_corr_table <- combined_correlation |>
  group_by(Class) |>
  summarise(
    median_correlation = median(correlation, na.rm = TRUE),
    n_pairs = sum(!is.na(correlation)),
    .groups = "drop"
  )

median_corr_table
```


### Correlations of Differential Expressed Proteins per Disease class

```{r}
# Step 1: Filter `DAid` for each `Class`
class_datasets <- meta |>
  group_by(Class) |>
  summarise(DAids = list(DAid), .groups = "drop")

# Step 2: Identify differentially expressed proteins for each `Class`
diff_exp_proteins_plot <- diff_exp_proteins |>
  mutate(
    sig_Olink = sig_Olink %in% c("significant up", "significant down"),
    sig_SomaScan = sig_SomaScan %in% c("significant up", "significant down"),
    both_significant = sig_Olink & sig_SomaScan & (sig_Olink == sig_SomaScan) # Same direction
  )

diff_exp_proteins_by_class <- diff_exp_proteins_plot |>
  group_by(Disease) |>
  summarise(
    olink_proteins = list(Assay[sig_Olink]),
    soma_proteins = list(Assay[sig_SomaScan]),
    both_proteins = list(Assay[both_significant]),
    .groups = "drop"
  )

# Step 3: Calculate correlations for each Class and protein category
correlation_results <- list()

for (i in seq_len(nrow(class_datasets))) {
  class_name <- class_datasets$Class[i]
  daids <- class_datasets$DAids[[i]]
  
  # Filter Olink and Soma datasets for the current class
  olink_filtered <- olink |> filter(DAid %in% daids)
  soma_filtered <- soma |> filter(DAid %in% daids)
  
  # Get differentially expressed proteins for the current class
  disease_name <- unique(meta |> filter(Class == class_name) |> pull(Disease))
  diff_proteins <- diff_exp_proteins_by_class |>
    filter(Disease %in% disease_name)
  
  olink_proteins <- unlist(diff_proteins$olink_proteins)
  soma_proteins <- unlist(diff_proteins$soma_proteins)
  both_proteins <- unlist(diff_proteins$both_proteins)
  
  # Calculate correlations for each protein category
  for (category in c("All Proteins", "Diff Expressed in Olink", "Diff Expressed in Soma", "Diff Expressed in Both")) {
    if (category == "All Proteins") {
      olink_subset <- olink_filtered
      soma_subset <- soma_filtered
    } else if (category == "Diff Expressed in Olink") {
      olink_subset <- olink_filtered |> filter(Assay %in% olink_proteins)
      soma_subset <- soma_filtered |> filter(Assay %in% olink_proteins)
    } else if (category == "Diff Expressed in Soma") {
      olink_subset <- olink_filtered |> filter(Assay %in% soma_proteins)
      soma_subset <- soma_filtered |> filter(Assay %in% soma_proteins)
    } else if (category == "Diff Expressed in Both") {
      olink_subset <- olink_filtered |> filter(Assay %in% both_proteins)
      soma_subset <- soma_filtered |> filter(Assay %in% both_proteins)
    }
    
    # Calculate correlations for the current category
    correlation_data <- olink_subset |>
      inner_join(soma_subset, by = c("DAid", "Assay")) |>
      group_by(Assay) |>
      summarise(
        correlation = if (sum(is.finite(NPX) & is.finite(Value)) > 1)
          suppressWarnings(cor(NPX, Value, method = "spearman", use = "complete.obs"))
        else
          NA_real_,
        .groups = "drop"
      ) |>
      mutate(Class = class_name, column = category)
    
    # Store the results
    correlation_results[[paste(class_name, category)]] <- correlation_data
  }
}

disease_class_order <- c("Healthy", "Cardiovascular", "Metabolic", "Cancer", "Neurologic", "Autoimmune", "Infection")
correlation_df <- bind_rows(correlation_results) |>
  mutate(
    column = factor(column, levels = c("All Proteins", "Diff Expressed in Olink", "Diff Expressed in Soma", "Diff Expressed in Both")),
    Class = factor(Class, levels = disease_class_order)
  )

# Calculate median correlation for each facet
median_corr <- correlation_df |>
  group_by(Class, column) |>
  summarise(median_correlation = median(correlation, na.rm = TRUE), .groups = "drop")

ggplot(correlation_df, aes(x = correlation, color = Class)) +
  geom_density(na.rm = TRUE, size = 0.7) +
  geom_text(
    data = median_corr,
    aes(x = -0.9, y = Inf, label = paste0("ρ = ", round(median_correlation, 2))),
    inherit.aes = FALSE,
    hjust = 0, vjust = 1.5, size = 3
  ) +
  scale_color_manual(values = disease_class, na.value = "lightgrey") +
  facet_grid(Class ~ column, scales = "free") +
  labs(x = "Spearman correlation (Olink vs Soma)", y = "Density", color = "Class") +
  theme_hd()

ggsave("results/platform_corr_by_class_density_ordered.png", width = 10, height = 8)
```

The same but for diseases.

```{r}
# Ensure# Step 1: Filter `DAid` for each `Disease`
disease_datasets <- meta |>
  group_by(Disease, Class) |>
  summarise(DAids = list(DAid), .groups = "drop")

# Step 2: Identify differentially expressed proteins for each `Disease`
diff_exp_proteins_by_disease <- diff_exp_proteins_plot |>
  group_by(Disease) |>
  summarise(
    olink_proteins = list(Assay[sig_Olink]),
    soma_proteins = list(Assay[sig_SomaScan]),
    both_proteins = list(Assay[both_significant]),
    .groups = "drop"
  )

# Step 3: Calculate correlations for each Disease and protein category
correlation_results <- list()

for (i in seq_len(nrow(disease_datasets))) {
  disease_name <- disease_datasets$Disease[i]
  class_name <- disease_datasets$Class[i]
  daids <- disease_datasets$DAids[[i]]
  
  # Filter Olink and Soma datasets for the current disease
  olink_filtered <- olink |> filter(DAid %in% daids)
  soma_filtered <- soma |> filter(DAid %in% daids)
  
  # Get differentially expressed proteins for the current disease
  diff_proteins <- diff_exp_proteins_by_disease |>
    filter(Disease == disease_name)
  
  olink_proteins <- unlist(diff_proteins$olink_proteins)
  soma_proteins <- unlist(diff_proteins$soma_proteins)
  both_proteins <- unlist(diff_proteins$both_proteins)
  
  # Calculate correlations for each protein category
  for (category in c("All Proteins", "Diff Expressed in Olink", "Diff Expressed in Soma", "Diff Expressed in Both")) {
    if (category == "All Proteins") {
      olink_subset <- olink_filtered
      soma_subset <- soma_filtered
    } else if (category == "Diff Expressed in Olink") {
      olink_subset <- olink_filtered |> filter(Assay %in% olink_proteins)
      soma_subset <- soma_filtered |> filter(Assay %in% olink_proteins)
    } else if (category == "Diff Expressed in Soma") {
      olink_subset <- olink_filtered |> filter(Assay %in% soma_proteins)
      soma_subset <- soma_filtered |> filter(Assay %in% soma_proteins)
    } else if (category == "Diff Expressed in Both") {
      olink_subset <- olink_filtered |> filter(Assay %in% both_proteins)
      soma_subset <- soma_filtered |> filter(Assay %in% both_proteins)
    }
    
    # Calculate correlations for the current category
    correlation_data <- olink_subset |>
      inner_join(soma_subset, by = c("DAid", "Assay")) |>
      group_by(Assay) |>
      summarise(
        correlation = if (sum(is.finite(NPX) & is.finite(Value)) > 1)
          suppressWarnings(cor(NPX, Value, method = "spearman", use = "complete.obs"))
        else
          NA_real_,
        .groups = "drop"
      ) |>
      mutate(Disease = disease_name, Class = class_name, column = category)
    
    # Store the results
    correlation_results[[paste(disease_name, category)]] <- correlation_data
  }
}

# Combine all results into a single dataframe
correlation_df <- bind_rows(correlation_results) |>
  mutate(
    column = factor(column, levels = c("All Proteins", "Diff Expressed in Olink", "Diff Expressed in Soma", "Diff Expressed in Both")),
    Class = factor(Class, levels = disease_class_order)  # Ensure correct class order
  ) |>
  filter(!Disease %in% c("Healthy", "BAMSE - visit 16", "BAMSE - visit 24", "BAMSE - visit 4", "BAMSE - visit 8")) |>
  mutate(
    Disease = factor(Disease, levels = meta |>
      mutate(Class = factor(Class, levels = disease_class_order)) |>  # Set correct class order
      arrange(Class, Disease) |> 
      pull(Disease) |> 
      unique())
  )

# Calculate median correlation for each facet
median_corr <- correlation_df |>
  group_by(Disease, column) |>
  summarise(median_correlation = median(correlation, na.rm = TRUE), .groups = "drop")

ggplot(correlation_df, aes(x = correlation, color = Class)) +
  geom_density(na.rm = TRUE, size = 0.7) +
  geom_text(
    data = median_corr,
    aes(x = -0.9, y = Inf, label = paste0("ρ = ", round(median_correlation, 2))),
    inherit.aes = FALSE,
    hjust = 0, vjust = 1.5, size = 3
  ) +
  scale_color_manual(values = disease_class, na.value = "lightgrey") +
  facet_grid(Disease ~ column) +  # Facet by Disease
  labs(x = "Spearman correlation (Olink vs Soma)", y = "Density", color = "Class") +
  theme_hd() +
  theme(
    strip.text.y = element_text(angle = 0),
    strip.text = element_text(size = 8)
  )

ggsave("results/platform_corr_by_disease_diffexp.png", width = 12, height = 20)
```

Is the correlation per class much different than the global correlation?

```{r}
# Step 1: Calculate global correlations
global_corr <- olink |>
  inner_join(soma, by = c("DAid", "Assay")) |>
  group_by(Assay) |>
  summarise(
    Global_corr = if (sum(is.finite(NPX) & is.finite(Value)) > 1)
      suppressWarnings(cor(NPX, Value, method = "spearman", use = "complete.obs"))
    else
      NA_real_,
    .groups = "drop"
  )

# Step 2: Calculate correlations per class
class_corr <- olink |>
  inner_join(soma, by = c("DAid", "Assay")) |>
  inner_join(meta |> select(DAid, Class), by = "DAid") |>
  group_by(Assay, Class) |>
  summarise(
    corr = if (sum(is.finite(NPX) & is.finite(Value)) > 1)
      suppressWarnings(cor(NPX, Value, method = "spearman", use = "complete.obs"))
    else
      NA_real_,
    .groups = "drop"
  ) |>
  pivot_wider(names_from = Class, values_from = corr, names_prefix = "Corr_Class_")

# Step 3: Calculate correlations per disease
disease_corr <- olink |>
  inner_join(soma, by = c("DAid", "Assay")) |>
  inner_join(meta |> select(DAid, Disease), by = "DAid") |>
  group_by(Assay, Disease) |>
  summarise(
    corr = if (sum(is.finite(NPX) & is.finite(Value)) > 1)
      suppressWarnings(cor(NPX, Value, method = "spearman", use = "complete.obs"))
    else
      NA_real_,
    .groups = "drop"
  ) |>
  pivot_wider(names_from = Disease, values_from = corr, names_prefix = "Corr_Disease_")

# Step 4: Add differential expression information
diff_exp_info <- diff_exp_proteins |>
  select(Assay, Disease, sig_Olink, sig_SomaScan) |>
  pivot_wider(
    names_from = Disease,
    values_from = c(sig_Olink, sig_SomaScan),
    names_glue = "{.value}_{Disease}"
  )

# Step 5: Combine all information into a single dataframe
protein_summary <- global_corr |>
  left_join(class_corr, by = "Assay") |>
  left_join(disease_corr, by = "Assay") |>
  left_join(diff_exp_info, by = "Assay")

write.table(protein_summary, file='data/platform_corr_summary_maria.tsv', quote=FALSE, sep='\t', col.names = NA)
```

Calculate deltas for classes and plot selected examples.

```{r}
# Step 1: Calculate deltas for classes
class_deltas <- class_corr |>
  pivot_longer(cols = starts_with("Corr_Class_"), names_to = "Class", values_to = "Class_corr") |>
  mutate(Class = str_remove(Class, "Corr_Class_")) |>
  left_join(global_corr, by = "Assay") |>
  mutate(delta_class = abs(Class_corr - Global_corr)) |>
  filter(Class_corr > 0, Class_corr > Global_corr)  # Only keep positive class correlations better than global

# Step 2: Define the selected examples
selected_examples <- tibble::tibble(
  Class = c(
    rep("Cancer", 3),
    rep("Metabolic", 4),
    rep("Cardiovascular", 2),
    rep("Infection", 2),
    rep("Autoimmune", 2),
    rep("Neurologic", 2)
  ),
  Assay = c(
    "LTAH4", "ENPP2", "CCL21",
    "FGR", "CAMK4", "PADI2", "PADI4",
    "PTN", "TNNI3",
    "TNFRSF8", "TK1",
    "VAV3", "NUDT2",
    "PRDX6", "HAGH"
  )
)

# Step 3: Prepare the data for plotting
scatter_data <- list()

for (i in seq_len(nrow(selected_examples))) {
  assay <- selected_examples$Assay[i]
  
  for (class in class_order) {
    # Filter the data for the current assay and class
    filtered_data <- if (class == "Global") {
      olink |>
        inner_join(soma, by = c("DAid", "Assay")) |>
        filter(Assay == assay)
    } else {
      olink |>
        inner_join(soma, by = c("DAid", "Assay")) |>
        inner_join(meta |> filter(Class == class), by = "DAid") |>
        filter(Assay == assay)
    }
    
    # Calculate the Spearman correlation
    correlation <- filtered_data |>
      summarise(
        rho = if (sum(is.finite(NPX) & is.finite(Value)) > 1)
          suppressWarnings(cor(NPX, Value, method = "spearman", use = "complete.obs"))
        else
          NA_real_
      ) |>
      pull(rho)
    
    # Add the data to the list
    scatter_data[[paste(assay, class)]] <- filtered_data |>
      mutate(
        Class = class,
        Assay = assay,
        rho = correlation
      )
  }
}

# Step 4: Combine all data into a single dataframe
scatter_data <- bind_rows(scatter_data) |>
  mutate(Class = factor(Class, levels = class_order))

# Step 5: Create a dataframe for labels
label_df <- scatter_data |>
  group_by(Assay, Class) |>
  summarise(
    x = max(NPX, na.rm = TRUE),  # Use max or Inf for positioning
    y = max(Value, na.rm = TRUE),
    rho = first(rho),  # Use the first (or unique) correlation value
    .groups = "drop"
  ) |>
  mutate(label = paste0(
    "ρ = ", round(rho, 2)
  ))

# Step 6: Plot the scatterplots
ggplot(scatter_data, aes(x = NPX, y = Value)) +
  geom_point(aes(color = Class), alpha = 0.6) +
  geom_smooth(method = "auto", se = TRUE, color = "black") +
  geom_text(
    data = label_df,
    aes(x = -Inf, y = Inf, label = label),
    hjust = -0.05, vjust = 1.2, size = 3
  ) +
  scale_color_manual(values = disease_class) +
  facet_grid(Assay ~ Class) +
  labs(x = "Olink (NPX)", y = "SomaScan (log2RFU)") +
  theme_hd() +
  theme(
    strip.text.x = element_text(size = 10),
    strip.text.y = element_text(size = 10),
    axis.text = element_text(size = 8),
    axis.title = element_text(size = 10)
  )

# Save the plot
ggsave("results/selected_examples_scatterplots_all_assays.png", width = 12, height = 10)
```










```{r}
# Calculate the Spearman correlation for each common Assay
correlation <- olink |>
  inner_join(soma, by = c("DAid", "Assay")) |>
  group_by(Assay, AptName) |>
  summarise(correlation = cor.test(NPX, Value, method = "spearman")$estimate) |>
  ungroup() |>
  left_join(gene_meta, by = "Assay") |>
  mutate(secretome_annotation = replace_na(secretome_annotation, "Unknown secreted location"))

median_correlation <- correlation |>
  pull(correlation) |>
  median()

# Plot a histogram of the correlation coefficient
ggplot(correlation, aes(x = correlation, fill = secretome_annotation)) +
  geom_histogram(binwidth = 0.1, color = "black", alpha = 0.7, position = "stack") +
  geom_text(x = median_correlation + 0.2, y = 1000, label = round(median_correlation, 4), color = "black", size = 5) +
  geom_vline(aes(xintercept = median_correlation), linetype = "dashed", color = "black") +
  labs(x = "Correlation Coefficient", y = "Proportion", fill = "Group") +
  scale_fill_manual(values = pal_secreted) + 
  theme_bw()

ggsave("results/platform_corr_global.png", width = 8, height = 4)
```

Per samples correlation

```{r}
# Join the olink and soma data
merged_dat <- soma |>
  left_join(olink, by = c("DAid", "Assay"))

# Calculate the correlation for each sample
sample_correlation <- merged_dat |> 
  group_by(DAid) |> 
  summarise(correlation = cor.test(NPX, Value, method = "spearman")$estimate) |> 
  ungroup()

# Calculate the median correlation per sample
median_correlation <- sample_correlation |> 
  pull(correlation) |> 
  median()

# Plot a histogram of the correlation coefficient per sample
ggplot(sample_correlation, aes(x = correlation)) +
  stat_bin(binwidth = 0.05, fill = "lightblue", alpha = 0.7) + 
  geom_vline(aes(xintercept = median_correlation), linetype = "dashed", color = "black") +
  geom_text(x = median_correlation + 0.2, y = 1000, label = round(median_correlation, 4), color = "black", size = 5) +
  labs(x = "Correlation Coefficient", y = "Count") +
  theme_bw()

ggsave("results/platform_corr_global_per_sample.png", width = 4, height = 3)

# Merge the selected_dat and meta data frames by DAid
merged_dat <- merged_dat |> 
  left_join(meta, by = "DAid") |>
  left_join(sample_correlation, by = "DAid")

# Create a violin plot of correlation by disease
ggplot(merged_dat, aes(x = Disease, y = correlation)) +
  geom_violin(aes(fill = Disease), trim = F, alpha = 0.7) +
  geom_segment(aes(x = Disease, xend = Disease, y = median(correlation), yend = median(correlation)), colour = "black") +
  labs(x = "Disease", y = "Correlation") +
  theme_bw() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )

ggsave("results/platform_corr_global_violin_by_disease.png", width = 7, height = 4)
```

Correlation per Disease

```{r}
olink_meta <- olink |>
  inner_join(meta, by = "DAid")

# Compute per-disease correlation per protein
r_disease <- olink_meta |>
  inner_join(soma, by = c("DAid", "Assay")) |>
  group_by(Disease, Assay, AptName) |>
  summarise(
    r = if (sum(is.finite(NPX) & is.finite(Value)) > 1)
      suppressWarnings(cor(NPX, Value, method = "spearman", use = "complete.obs"))
    else NA_real_,
    .groups = "drop"
  )

# Summarise per-disease median correlation per protein
r_matrix <- r_disease |>
  group_by(Assay, AptName, Disease) |>
  summarise(median_r = median(r, na.rm = TRUE), .groups = "drop") |>
  pivot_wider(names_from = Disease, values_from = median_r)

# Clustered heatmap (proteins × diseases)
r_mat <- r_matrix |> select(where(is.numeric)) |> as.data.frame()
rownames(r_mat) <- paste(r_matrix$Assay, r_matrix$AptName, sep = "_")

row_ann <- r_matrix |>
  left_join(gene_meta, by = "Assay") |>
  mutate(secretome_annotation = replace_na(secretome_annotation, "Unknown secreted location")) |>
  select(Assay, AptName, secretome_annotation) |>
  mutate(rowname = paste(Assay, AptName, sep = "_")) |>
  tibble::column_to_rownames("rowname") |>
  select(secretome_annotation)

row_ann <- row_ann[rownames(r_mat), , drop = FALSE]
ann_colors <- list(secretome_annotation = pal_secreted)

heatmap <- pheatmap(
  r_mat,
  cluster_rows = TRUE,
  cluster_cols = TRUE,
  show_rownames = FALSE,
  color = colorRampPalette(c("navy", "white", "firebrick3"))(100),
  na_col = "grey80",
  main = "Per-Disease Median Spearman Correlation",
  annotation_row = row_ann,
  annotation_colors = ann_colors
)

ggsave("results/platform_corr_global_per_disease.png", heatmap, width = 8, height = 18)

# Identify proteins with large overall disagreement
# Disagreement defined as high cross-disease variability in correlation
r_var <- r_disease |>
  group_by(Assay, AptName) |>
  summarise(sd_r = sd(r, na.rm = TRUE), .groups = "drop") |>
  arrange(desc(sd_r))

# Flag proteins with large variance in per-disease correlation
flagged <- r_var |> filter(sd_r > 0.35)

# Plot per-disease correlations for flagged proteins
flagged_plot <- r_disease |>
  inner_join(flagged, by = c("Assay", "AptName")) |>
  mutate(Protein = paste(Assay, AptName, sep = "_"))

ggplot(flagged_plot, aes(x = Disease, y = r, group = Protein)) +
  geom_point() +
  geom_line(aes(color = Protein), alpha = 0.6) +
  theme_bw() +
  labs(
    x = "Disease group",
    y = "Spearman correlation (Olink vs Soma)",
    title = "Per-disease correlation for proteins with disease-dependent disagreement"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "none"
  )

ggsave("results/variable_per_disease_proteins_corr.png", width = 8, height = 4)
```

Correlations for different Olink protein LOD bins

```{r}
below_LOD <- olink |>
  group_by(Assay) |>
  summarise(
    prop_below_LOD = mean(NPX < LOD, na.rm = TRUE)
  )

bins <- c(0, 0.1, 0.25, 0.5, 0.75, 1)
below_LOD <- below_LOD |>
  mutate(bin = cut(prop_below_LOD, breaks = bins, include.lowest = TRUE))

correlation <- olink |>
  inner_join(soma, by = c("DAid", "Assay")) |>
  group_by(Assay, AptName) |>
  summarise(
    correlation = suppressWarnings(cor.test(NPX, Value, method = "spearman")$estimate),
    .groups = "drop"
  )

correlation_binned <- correlation |>
  left_join(below_LOD, by = "Assay") |>
  left_join(gene_meta, by = "Assay") |>
  mutate(secretome_annotation = replace_na(secretome_annotation, "Unknown secreted location")) |>
  mutate(
    secretome_annotation = if_else(
      secretome_annotation != "Actively secreted to blood", 
      "Non secreted in blood", 
      "Actively secreted to blood"
    )
  ) |>
  left_join(protein_tiers, by = "Assay")

ggplot(correlation_binned, aes(x = bin, y = correlation)) +
  geom_violin(trim = FALSE, color = "black") +
  geom_boxplot(width = 0.1, outlier.shape = NA) +
  theme_bw() +
  labs(
    x = "Proportion of samples below LOD (Olink)",
    y = "Correlation Coefficient"
  )

ggsave("results/platform_corr_global_bins.png", width = 10, height = 4)

ggplot(correlation_binned, aes(x = bin, y = correlation, fill = secretome_annotation)) +
  geom_violin(trim = FALSE, color = "black") +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9)) +
  theme_bw() +
  scale_fill_manual(values = c(
    "Actively secreted to blood" = "#B24F52",
    "Non secreted in blood" = "#7C7C7C"
  )) +
  labs(
    x = "Proportion of samples below LOD (Olink)",
    y = "Correlation Coefficient"
  )

ggsave("results/platform_corr_global_bins_secretome.png", width = 10, height = 4)

ggplot(correlation_binned, aes(x = bin, y = correlation, fill = Tier)) +
  geom_violin(trim = FALSE, color = "black") +
  geom_boxplot(width = 0.1, outlier.shape = NA, position = position_dodge(width = 0.9)) +
  theme_bw() +
  scale_fill_brewer() + 
  labs(
    x = "Proportion of samples below LOD (Olink)",
    y = "Correlation Coefficient"
  )


ggsave("results/platform_corr_global_bins_tiers.png", width = 10, height = 4)

# Compute median correlation per Tier
median_correlation <- correlation_binned |>
  group_by(Tier) |>
  summarise(median_correlation = median(correlation, na.rm = TRUE))

# Plot faceted histograms with median lines
ggplot(correlation_binned, aes(x = correlation, fill = Tier)) +
  geom_histogram(color = "black", position = "identity") +
  geom_vline(
    data = median_correlation,
    aes(xintercept = median_correlation),
    linetype = "dashed",
    color = "black"
  ) +
  facet_wrap(~Tier) +
  theme_bw() +
  scale_fill_brewer() +
  labs(
    x = "Correlation Coefficient",
    y = "Count"
  )

ggsave("results/platform_corr_global_hist_tiers.png", width = 10, height = 4)
```

Correlations for Assays/Samples above LOD vs bellow LOD (Olink)

```{r}
# Separate data based on LOD
olink_below <- olink |> filter(NPX < LOD) |> mutate(LOD_group = "Below LOD")
olink_above <- olink |> filter(NPX >= LOD) |> mutate(LOD_group = "Above LOD")

olink_split <- bind_rows(olink_below, olink_above)

# Compute correlation per Assay and group (below/above LOD)
correlation <- olink_split |>
  inner_join(soma, by = c("DAid", "Assay")) |>
  group_by(LOD_group, Assay, AptName) |>
  summarise(
    correlation = if (sum(is.finite(NPX) & is.finite(Value)) > 1)
      suppressWarnings(cor(NPX, Value, method = "spearman", use = "complete.obs"))
    else
      NA_real_,
    .groups = "drop"
  ) |>
  filter(!is.na(correlation))

median_corr <- correlation |>
  group_by(LOD_group) |>
  summarise(median_correlation = median(correlation, na.rm = TRUE))

ggplot(correlation, aes(x = correlation)) +
  stat_bin(binwidth = 0.1, fill = "lightblue", alpha = 0.7) +
  geom_vline(
    data = median_corr,
    aes(xintercept = median_correlation),
    linetype = "dashed",
    color = "black"
  ) +
  geom_text(
    data = median_corr,
    aes(x = median_correlation + 0.4, y = Inf,
        label = round(median_correlation, 4)),
    vjust = 2, color = "black", size = 4
  ) +
  labs(x = "Spearman Correlation", y = "Count") +
  facet_wrap(~ LOD_group, nrow = 1) +
  theme_bw()

ggsave("results/platform_corr_global_LOD_split.png", width = 6, height = 3)

```

Soma intra-correlation vs correlation with Olink

```{r}
aptamer_counts <- apt_per_assay |>
  filter(n_apt > 1) 

soma_multi <- soma |>
  semi_join(aptamer_counts, by = "Assay")

intra_corr <- soma_multi |>
  group_by(Assay) |>
  summarise(
    cor_matrix = list({
      df <- pivot_wider(cur_data(), names_from = AptName, values_from = Value)
      mat <- cor(df |> select(-DAid), use = "pairwise.complete.obs", method = "spearman")
      mat[lower.tri(mat)]
    }),
    .groups = "drop"
  ) |>
  unnest_longer(cor_matrix, values_to = "r_intra")

aptamer_olink_corr <- soma_multi |>
  inner_join(olink, by = c("DAid", "Assay")) |>
  group_by(Assay, AptName) |>
  summarise(
    r_olink = if (sum(is.finite(Value) & is.finite(NPX)) > 1)
      suppressWarnings(cor(Value, NPX, method = "spearman", use = "complete.obs"))
    else NA_real_,
    .groups = "drop"
  )

# Compute median intra-aptamer r per protein
median_intra <- intra_corr |>
  group_by(Assay) |>
  summarise(median_intra = median(r_intra, na.rm = TRUE))

# Combine with aptamer-specific Olink correlations
combined <- aptamer_olink_corr |>
  left_join(median_intra, by = "Assay") |>
  left_join(below_LOD, by = "Assay")

ggplot(combined, aes(x = median_intra, y = r_olink, color = bin)) +
  geom_point(size = 1) +
  geom_smooth(method = "loess", se = TRUE, color = "black") +
  labs(
    x = "Median intra-aptamer correlation (SomaScan)",
    y = "Aptamer-specific Olink correlation",
    title = "Aptamer consistency vs Olink concordance"
  ) +
  theme_bw()

ggsave("results/aptamer_intra_vs_olink_scatter.png", width = 6, height = 4)
```

Correlation vs abundance and variance

```{r}
# Olink stats per Assay (all NPX observations)
olink_stats <- olink |>
  group_by(Assay) |>
  summarise(
    mean_olink = mean(NPX, na.rm = TRUE),
    median_olink = median(NPX, na.rm = TRUE),
    var_olink = var(NPX, na.rm = TRUE),
    sd_olink = sd(NPX, na.rm = TRUE),
    cv_olink = ifelse(mean_olink != 0, sd_olink/mean_olink, NA_real_),
    .groups = "drop"
  )

# Soma stats per AptName (Value)
soma_stats <- soma |>
  group_by(AptName) |>
  summarise(
    mean_soma = mean(Value, na.rm = TRUE),
    median_soma = median(Value, na.rm = TRUE),
    var_soma = var(Value, na.rm = TRUE),
    sd_soma = sd(Value, na.rm = TRUE),
    cv_soma = ifelse(mean_soma != 0, sd_soma/mean_soma, NA_real_),
    .groups = "drop"
  )

# Join stats to comparison table
cmp_stats <- comparison |>
  left_join(olink_stats, by = "Assay") |>
  left_join(soma_stats, by = "AptName") |>
  # avoid zeros for log CV
  mutate(logCV_olink = log10(cv_olink + 1),
         logCV_soma  = log10(cv_soma  + 1)) |>
  filter(!is.na(r_all))

# Olink abundance/variance vs correlation
ggplot(cmp_stats, aes(x = mean_olink, y = r_all, , color = bin)) +
  geom_point(alpha = 0.6) +
  labs(
    x = "Mean Olink (NPX)",
    y = "Spearman correlation (all samples)"
  ) +
  scale_colour_brewer(palette = "Set1") +
  theme_bw() 

ggsave("results/mean_olink_vs_corr.png", width = 6, height = 5)

ggplot(cmp_stats, aes(x = logCV_olink, y = r_all, , color = bin)) +
  geom_point(alpha = 0.6) +
  labs(
    x = "Log10(CV) Olink (NPX)",
    y = "Spearman correlation (all samples)"
  ) +
  scale_colour_brewer(palette = "Set1") +
  theme_bw() 

ggsave("results/cv_olink_vs_corr.png", width = 6, height = 5)

# Soma abundance/variance vs correlation
ggplot(cmp_stats, aes(x = mean_soma, y = r_all, , color = bin)) +
  geom_point(alpha = 0.6) +
  labs(
    x = "Mean SomaScan (Value)",
    y = "Spearman correlation (all samples)"
  ) +
  scale_colour_brewer(palette = "Set1") +
  theme_bw() 

ggsave("results/mean_soma_vs_corr.png", width = 6, height = 5)

ggplot(cmp_stats, aes(x = logCV_soma, y = r_all, , color = bin)) +
  geom_point(alpha = 0.6) +
  labs(
    x = "Log10(CV) SomaScan (Value)",
    y = "Spearman correlation (all samples)"
  ) +
  scale_colour_brewer(palette = "Set1") +
  theme_bw() 

ggsave("results/cv_soma_vs_corr.png", width = 6, height = 5)

# Mean/CV olink vs Mean/CV Soma vs Correlation
ggplot(cmp_stats, aes(x = mean_olink, y = mean_soma, z = r_all)) +
  stat_summary_2d(fun = mean, bins = 50, na.rm = TRUE) +
  scale_fill_viridis_c(option = "B", na.value = "grey50") +
  labs(x = "Mean Olink (NPX)", y = "Mean SomaScan (Value)", fill = "Mean r") +
  theme_bw()

ggsave("results/mean_soma_vs_mean_olink_heatmap.png", width = 6, height = 5)

ggplot(cmp_stats, aes(x = logCV_olink, y = logCV_soma, z = r_all)) +
  stat_summary_2d(fun = mean, bins = 50, na.rm = TRUE) +
  scale_fill_viridis_c(option = "B", na.value = "grey50") +
  labs(x = "Log10(CV) Olink (NPX)", y = "Log10(CV) SomaScan (Value)", fill = "Mean r") +
  theme_bw()

ggsave("results/cv_soma_vs_cv_olink_heatmap.png", width = 6, height = 5)
```


## Plot individual assay scatter plots

Example low correlation proteins as scatterplot (Olink vs Soma)

```{r}
random_faceted_plot <- function(correlation, olink, soma, n, threshold = 0.5) {
  assays_to_select <- correlation |>
    filter(correlation < threshold)
  
  if (nrow(assays_to_select) <= 1) {
    stop("Not enough correlations with correlation lower than 0.5 to select.")
  }

  # Randomly select n Assay values from the filtered data frame
  selected_assays <- assays_to_select |>
    dplyr::slice_sample(n = n) |>
    pull(Assay)

  # Select the corresponding rows from the soma and olink data frames
  selected_dat <- soma |>
    filter(Assay %in% selected_assays) |>
    left_join(olink |> filter(Assay %in% selected_assays), by = c("DAid", "Assay")) |>
    left_join(correlation |> select(Assay, AptName, correlation), by = c("Assay", "AptName"))
  
  label_df <- selected_dat |>
    group_by(Assay, AptName, correlation) |>
    summarize(x = max(NPX, na.rm = TRUE),
              y = max(Value, na.rm = TRUE),
              .groups = "drop")

  # Create the faceted plot
  ggplot(selected_dat, aes(x = NPX, y = Value)) +
    geom_point() +
    geom_text(data = label_df,
              aes(x = Inf, y = Inf, label = paste0("r = ", round(correlation, 3))),
              hjust = 1, vjust = 1, size = 3) +
    facet_wrap(~Assay + AptName) +
    labs(x = "Olink NPX", y = "Soma Value") +
    theme_bw()
}

random_faceted_plot(correlation, olink, soma, n = 10, threshold = 0)
```

Plot selected assays

```{r}
selected_assays <- c("DDC", "VWF", "NANOG", "NPPB", "SMCO3", "CILP", "FN1", "CHUK", "TRAF2", "CNDP1", "DEFA6", "TUBA1A", "SUMF1")

above_lod <- olink |>
  group_by(Assay) |>
  summarise(perc_above_lod = mean(NPX >= LOD, na.rm = TRUE) * 100)

selected_dat <- soma |>
  filter(Assay %in% selected_assays) |>
  left_join(olink |> filter(Assay %in% selected_assays), by = c("DAid", "Assay")) |>
  left_join(correlation |> select(Assay, AptName, correlation), by = c("Assay", "AptName")) |>
  left_join(above_lod, by = "Assay")
  
label_df <- selected_dat |>
  group_by(Assay, AptName, correlation, perc_above_lod) |>
  summarise(x = max(NPX, na.rm = TRUE),
            y = max(Value, na.rm = TRUE),
            .groups = "drop") |>
  mutate(label = paste0(
    "r = ", round(correlation, 3), 
    "\nAbove LOD = ", round(perc_above_lod, 1), "%"
  ))

  # Create the faceted plot
ggplot(selected_dat, aes(x = NPX, y = Value)) +
  geom_point() +
  geom_text(data = label_df,
          aes(x = Inf, y = Inf, label = label),
          hjust = 1.05, vjust = 1.2, size = 3) +
  facet_wrap(~Assay + AptName) +
  labs(x = "Olink NPX", y = "Soma Value") +
  theme_bw()
```