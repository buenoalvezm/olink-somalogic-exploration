# Platform Correlations

## Setup & Data

```{r}
library(readr)
library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(patchwork)
library(HDAnalyzeR)
library(ggpubr)
library(stringr)
library(gridExtra)
library(tidymodels)
library(vip)
```

```{r}
# Olink -----
olink <- read_tsv("data/data_phase2_HT_bridged_curated_subset_20251031.tsv") |>
    select("DAid", "Assay", "UniProt", "Batch", "NPX", "LOD")

# Soma -----
soma_wide <- read_tsv("data/data_phase2_somalogic_curated_subset_20251031.tsv")
soma_meta <- read_tsv("data/meta_phase2_somalogic_elod_20251028.tsv")

soma <- soma_wide |>
  pivot_longer(cols = -c("DAid"), names_to = "AptName", values_to = "Value") |>
  left_join(soma_meta |> filter(Organism == "Human") |> select(AptName,eLOD, EntrezGeneSymbol), by = "AptName") |>
  rename(Assay = EntrezGeneSymbol)

rm(soma_wide)

# Sample metadata ----
sample_meta <- read_excel("data/samples_2025-10-10.xlsx") |>
  mutate(
    Disease = ifelse(Cohort == "PARD", Diagnose, Disease),
    Disease = ifelse(Disease %in% c("Healthy control", "healthy", "Control"), "Healthy", Disease),
    Disease = case_when(Disease == "Pancreatic ductal adenocarcinoma" ~ "Pancreatic cancer",
                        Diagnose == "OVC" ~  "Ovarian cancer",
                        Diagnose == "BRC" ~ "Breast cancer",
                        Diagnose == "LUNG" ~ "Lung cancer",
                        Diagnose == "CRC" ~ "Colorectal cancer",
                        Diagnose == "PRC" ~ "Prostate cancer",
                        Diagnose == "4_random" ~ "BAMSE - visit 4",
                        Diagnose == "8_random" ~ "BAMSE - visit 8",
                        Diagnose == "16_random" ~ "BAMSE - visit 16",
                        Diagnose == "24_random" ~ "BAMSE - visit 24",
                        Diagnose == "pregnancy" ~ "Pregnancy",
                        Diagnose == "PD" ~ "Parkinson's disease",
                        T ~ Disease),
    Class = case_when(Disease %in% c("Breast cancer", "Colorectal cancer", "Lung cancer", "Ovarian cancer", "Prostate cancer") ~ "Cancer",
                      Disease == "Parkinson's disease" ~ "Neurologic",
                      Cohort == "BAMS" ~ "Healthy",
                      Cohort == "PREG" ~ "Healthy",
                      Disease == "Healthy" ~ "Healthy",
                      T ~ Class)
    ) |>
  select(DAid, Cohort, Class, Disease, Age, Sex, BMI)

# Other protein imformation ----
gene_secretome <- read_csv("data/gene_secretome.csv")

protein_tiers <- read_excel("data/proteins_classified_tiers.xlsx") |>
  select(Assay = Gene, Tier = `confidence tier`) |>
  mutate(Tier = as.factor(Tier))

diff_exp_proteins <- read_tsv("data/de_diseases_olink_soma_overlapping.tsv")

hpa_metadata <- read_tsv("data/proteinatlas.tsv")
```

Palettes

```{r}
pal_secreted <- c(
  "Actively secreted to blood" = "#B24F52",
  "Secreted in female reproductive system" = "#2A9D8F",
  "Unknown secreted location" = "#7C7C7C",
  "Secreted in male reproductive system" = "#A9D18E",
  "Secreted to extracellular matrix" = "#A6CEE3",
  "Secreted to digestive system" = "#264653",
  "Secreted in brain" = "#F4A5AE",
  "Secreted to other locations" = "#B89B74",
  "Digestive system" = "#264653",
  "Intracellular and Membrane" = "#457B9D",
  "Not part of the secretome annotation" = "lightgrey"
)

disease_class <- c(
  "Global" = "#E5E5E5",  # Add a color for Global
  "Healthy" = "#C9B28F",
  "Cardiovascular" = "#ED936B",
  "Metabolic" = "#E0C59A",
  "Cancer" = "#919FC7",
  "Neurologic" = "#7DC0A6",
  "Psychiatric" = "#7DC0A6",
  "Infection" = "#F9DA56",
  "Autoimmune" = "#DA8EC0"
)
```

Define order:

```{r}
class_order <- c("Global", "Healthy", "Cardiovascular", "Metabolic", "Cancer", "Neurologic", "Autoimmune", "Infection")
disease_class_order <- c("Healthy", "Cardiovascular", "Metabolic", "Cancer", "Neurologic", "Autoimmune", "Infection")
```

Select common proteins and DAids.

```{r}
common_daids <- intersect(unique(olink |> pull(DAid)), unique(soma |> pull(DAid)))
common_assays <- intersect(unique(olink |> pull(Assay)), unique(soma |> pull(Assay)))

olink <- olink |> filter(DAid %in% common_daids, Assay %in% common_assays)
soma <- soma |> filter(DAid %in% common_daids, Assay %in% common_assays)

meta <- sample_meta |> filter(DAid %in% common_daids)
```

## Correlations Figure

### Global and per Disease Correlations

Global correlation (top-left) stacked version based on secretome annotation

```{r}
correlation <- olink |>
  inner_join(soma, by = c("DAid", "Assay")) |>
  group_by(Assay, AptName) |>
  summarise(
    correlation = if (sum(is.finite(NPX) & is.finite(Value)) > 1)
      suppressWarnings(cor(NPX, Value, method = "spearman", use = "complete.obs"))
    else
      NA_real_,
    .groups = "drop"
  ) |>
  mutate(Disease = "Global")

correlation_by_disease <- olink |>
  inner_join(soma, by = c("DAid", "Assay")) |>
  inner_join(meta |> select(DAid, Disease), by = "DAid") |>
  group_by(Disease, Assay, AptName) |>
  summarise(
    correlation = if (sum(is.finite(NPX) & is.finite(Value)) > 1)
      suppressWarnings(cor(NPX, Value, method = "spearman", use = "complete.obs"))
    else
      NA_real_,
    .groups = "drop"
  )

combined_correlation_disease <- bind_rows(correlation, correlation_by_disease)

# Prepare data with secretome annotation
correlation_secretome <- correlation |>
  left_join(gene_secretome, by = "Assay") |>
  mutate(
    secretome_annotation = replace_na(secretome_annotation, "Unknown secreted location"),
    secretome_annotation = case_when(
      secretome_annotation == "Actively secreted to blood" ~ "Actively secreted to blood",
      secretome_annotation %in% c("Unknown secreted location", "Intracellular and Membrane") ~ "Not secreted",
      TRUE ~ "Secreted to other locations"
    ),
    secretome_annotation = factor(secretome_annotation, 
                                  levels = c("Actively secreted to blood",
                                           "Secreted to other locations", 
                                           "Not secreted"))
  )

global_cor_plot_secretome <- ggplot(correlation_secretome, aes(x = correlation, fill = secretome_annotation)) +
  geom_histogram(binwidth = 0.05, color = "black", position = "stack") +
  scale_fill_manual(
    values = c(
      "Actively secreted to blood" = "#A62216",
      "Secreted to other locations" = "#EBA695",
      "Not secreted" = "#CDCCCB"
    ),
    name = "Secretome Location"
  ) +
  xlim(-0.7, 1) +
  ylim(0, 650) +
  labs(
    x = "Baseline Correlations",
    y = "# Proteins"
  ) +
  theme_hd() +
  theme(
    axis.text = element_text(size = 6),
    axis.text.x = element_text(vjust = 1, hjust = 0.5),
    axis.title = element_text(size = 8),
    axis.ticks.length = unit(4, "pt"),
    legend.position = "right",
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 8, face = "bold"),
    legend.key.size = unit(6, "pt"),
    plot.margin = margin(t = 5, r = 5, b = 5, l = 5)
  )
```

Calculate maximum correlation per protein across Diseases and plot distribution. Max correlation (top-right) stacked version based on secretome annotation

```{r}
max_correlation <- correlation_by_disease |>
  group_by(Assay, AptName) |>
  filter(correlation == max(correlation, na.rm = TRUE)) |>
  ungroup() |>
  mutate(Disease = "Max")

# Prepare max correlation data with secretome annotation
max_correlation_secretome <- max_correlation |>
  left_join(gene_secretome, by = "Assay") |>
  mutate(
    secretome_annotation = replace_na(secretome_annotation, "Unknown secreted location"),
    secretome_annotation = case_when(
      secretome_annotation == "Actively secreted to blood" ~ "Actively secreted to blood",
      secretome_annotation %in% c("Unknown secreted location", "Intracellular and Membrane") ~ "Not secreted",
      TRUE ~ "Secreted to other locations"
    ),
    secretome_annotation = factor(secretome_annotation, 
                                  levels = c("Actively secreted to blood",
                                           "Secreted to other locations", 
                                           "Not secreted"))
  )

max_cor_plot_secretome <- ggplot(max_correlation_secretome, aes(x = correlation, fill = secretome_annotation)) +
  geom_histogram(binwidth = 0.05, color = "black", position = "stack") +
  scale_fill_manual(
    values = c(
      "Actively secreted to blood" = "#A62216",
      "Secreted to other locations" = "#EBA695",
      "Not secreted" = "#CDCCCB"
    ),
    name = "Secretome Location"
  ) +
  xlim(-0.7, 1) +
  ylim(0, 650) +
  labs(
    x = "Disease Improved Correlations"
  ) +
  theme_hd() +
  theme(
    axis.text = element_text(size = 6),
    axis.title.y = element_blank(),
    axis.text.x = element_text(vjust = 1, hjust = 0.5),
    axis.title.x = element_text(size = 8),
    axis.ticks.length = unit(4, "pt"),
    legend.position = "right",
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 8, face = "bold"),
    legend.key.size = unit(6, "pt"),
    plot.margin = margin(t = 5, r = 5, b = 5, l = 5)
  )
```

```{r}
# Define arrow
arrow_plot <- ggplot() +
  geom_polygon(
    aes(x = c(0, 1, 0), y = c(0, 0.5, 1)),  # Triangle vertices
    fill = "#E5E5E5"
  ) +
  theme_void() +
  theme(plot.margin = margin(t = 0, r = 5, b = 0, l = 5))

global_cor_plot_secretome_no_legend <- global_cor_plot_secretome + 
  theme(legend.position = "none")

max_cor_plot_secretome_no_legend <- max_cor_plot_secretome + 
  theme(legend.position = "none")

# Extract legend from one of the plots
legend <- get_legend(global_cor_plot_secretome + 
  theme(legend.position = "bottom", legend.direction = "horizontal"))

global_cor_plot_secretome_no_legend <- global_cor_plot_secretome_no_legend + labs(tag = "A")
max_cor_plot_secretome_no_legend <- max_cor_plot_secretome_no_legend + labs(tag = "B")

# Combine plots with arrow in between
combined_secretome_plot <- global_cor_plot_secretome_no_legend + arrow_plot + max_cor_plot_secretome_no_legend +
  plot_layout(ncol = 3, widths = c(1, 0.1, 1)) +
  plot_annotation(theme = theme(plot.margin = margin(t = 5, r = 5, b = 0, l = 5)))

# Add legend at bottom
final_combined_plot <- combined_secretome_plot / legend +
  plot_layout(heights = c(1, 0.05))

ggsave(
  filename = "results/platform_correlations_overview.png",
  plot = final_combined_plot,
  width = 21,
  height = 7,
  units = "cm"
)
```

### Selected Examples

```{r}
selected_examples <- tibble::tibble(
  Assay = c("TWF2", "ECE1", "FGR", "PTN")
)

scatter_data <- list()
for (i in seq_len(nrow(selected_examples))) {
  assay <- selected_examples$Assay[i]
  
  for (class in class_order) {
    # Filter the data for the current assay and class
    filtered_data <- if (class == "Global") {
      olink |>
        inner_join(soma, by = c("DAid", "Assay")) |>
        filter(Assay == assay)
    } else {
      olink |>
        inner_join(soma, by = c("DAid", "Assay")) |>
        inner_join(meta |> filter(Class == class), by = "DAid") |>
        filter(Assay == assay)
    }

    correlation_ <- filtered_data |>
      summarise(
        rho = if (sum(is.finite(NPX) & is.finite(Value)) > 1)
          suppressWarnings(cor(NPX, Value, method = "spearman", use = "complete.obs"))
        else
          NA_real_
      ) |>
      pull(rho)
    
    scatter_data[[paste(assay, class)]] <- filtered_data |>
      mutate(
        Class = class,
        Assay = assay,
        rho = correlation_
      )
  }
}

scatter_data <- bind_rows(scatter_data) |>
  mutate(Class = factor(Class, levels = class_order))

label_df <- scatter_data |>
  group_by(Assay, Class) |>
  summarise(
    x = max(NPX, na.rm = TRUE),
    y = max(Value, na.rm = TRUE),
    rho = first(rho),
    .groups = "drop"
  ) |>
  mutate(label = paste0("ρ = ", round(rho, 2)))

best_aptname <- correlation |>
  as_tibble() |>
  group_by(Assay) |>
  filter(correlation == max(correlation, na.rm = TRUE)) |>
  slice(1) |>
  ungroup() |>
  select(Assay, AptName)

soma_filtered <- soma |>
  inner_join(best_aptname, by = c("Assay", "AptName")) |>
  filter(Assay %in% selected_examples$Assay) |>
  select(DAid, Assay, Value) |>
  mutate(Technology = "SomaScan")

olink_filtered <- olink |>
  filter(Assay %in% selected_examples$Assay) |>
  select(DAid, Assay, Value = NPX) |>
  mutate(Technology = "Olink")

combined_data <- bind_rows(soma_filtered, olink_filtered) |>
  inner_join(meta |>select(DAid, Class, Disease), by = "DAid") |>
  mutate(
    Disease = factor(Disease, levels = meta |>
      mutate(Class = factor(Class, levels = disease_class_order)) |>
      arrange(Class, Disease) |> 
      pull(Disease) |> 
      unique())
  )
```

```{r}
thresholds <- tibble::tibble(
  Assay = c("TWF2", "ECE1", "FGR", "PTN"),
  Olink_min = c(NA, -2, NA, NA),
  Olink_max = c(NA, 3, NA, NA),
  SomaScan_min = c(NA, 8, 6, NA),
  SomaScan_max = c(NA, 12, 11, NA)
)

protein_plots <- list()
for (protein in unique(scatter_data$Assay)) {
  scatter_data_filtered <- scatter_data |> 
    filter(Assay == protein)
  label_df_filtered <- label_df |> 
    filter(Assay == protein)

  scatter_plot <- ggplot(scatter_data_filtered, aes(x = NPX, y = Value)) +
    geom_point(aes(color = Class), alpha = 0.6, size = 0.5) +
    geom_smooth(
      data = scatter_data_filtered |> filter(rho >= 0.7),
      method = "auto", se = TRUE, color = "black"
    ) +
    geom_text(
      data = label_df_filtered,
      aes(x = -Inf, y = Inf, label = label),
      hjust = -0.05, vjust = 1.2, size = 2.5
    ) +
    scale_x_continuous(breaks = scales::breaks_pretty()) +
    scale_y_continuous(breaks = scales::breaks_pretty()) +
    scale_color_manual(values = disease_class) +
    facet_wrap(~ Class, nrow = 1, scales = "free") +
    labs(x = "Olink (NPX)", y = "SomaScan (log2RFU)") +
    theme_hd() +
    theme(
      legend.position = "None",
      strip.text = element_text(size = 6, margin = margin(2,0,2,0, "pt")),
      axis.text = element_text(size = 6),
      axis.title = element_text(size = 8),
      axis.text.x = element_text(hjust = 0.5),
      axis.ticks.length = unit(4, "pt"),
      plot.margin = margin(t = 5, r = 5, b = 5, l = 5)
    )
  
  annotation_plot <- ggplot(data = tibble(Assay = protein), aes(y = Assay)) +
    geom_text(aes(x = 1, label = Assay), hjust = 0.5, vjust = 0.5, size = 4, angle = 90, fontface = "bold") +
    theme_void() +
    theme(
      plot.margin = margin(t = 0, r = 0, b = 0, l = 0),
      panel.background = element_rect(fill = "#E5E5E5", color = NA),
      panel.border = element_rect(fill = NA, color = NA, linewidth = 0.5)
    )
  
  combined_plot <- annotation_plot + scatter_plot + plot_layout(widths = c(0.02, 1))
  protein_plots[[protein]] <- combined_plot
}

for (i in seq_along(protein_plots)) {
  if (i == 1) {
    protein_plots[[i]][[2]] <- protein_plots[[i]][[2]] &
      theme(strip.text = element_text(size = 6),
            strip.background = element_rect(fill = "grey90"))
  } else {
    protein_plots[[i]][[2]] <- protein_plots[[i]][[2]] &
      theme(strip.text = element_blank(),
            strip.background = element_blank())
  }
  
  if (i < length(protein_plots)) {
    protein_plots[[i]][[2]] <- protein_plots[[i]][[2]] &
      theme(axis.title.x = element_blank())
  }
}

protein_plots[[1]][[1]] <- protein_plots[[1]][[1]] + labs(tag = "C")

scatter_section <- wrap_plots(protein_plots, ncol = 1)
scatter_wrapped <- wrap_elements(full = scatter_section)

boxplot_proteins <- c("FGR", "PTN")
boxplot_list <- list()

color_bar <- ggplot(
  meta |> distinct(Disease, Class) |> 
    mutate(Disease = factor(Disease, levels = levels(combined_data$Disease))),
  aes(x = Disease, y = 1, fill = Class)
) +
  geom_tile() +
  scale_fill_manual(values = disease_class) +
  theme_void() +
  theme(
    legend.position = "None",
    plot.margin = margin(t = 0, r = 5, b = 0, l = 5)
  )

for (protein in boxplot_proteins) {
  combined_data_filtered <- combined_data |> 
    filter(Assay == protein)
  
  thresholds_current <- thresholds |> filter(Assay == protein)
  
  combined_data_filtered <- combined_data_filtered |> 
    filter(
      (Technology == "Olink" & 
       (is.na(thresholds_current$Olink_min) | Value >= thresholds_current$Olink_min) &
       (is.na(thresholds_current$Olink_max) | Value <= thresholds_current$Olink_max)) |
      (Technology == "SomaScan" & 
       (is.na(thresholds_current$SomaScan_min) | Value >= thresholds_current$SomaScan_min) &
       (is.na(thresholds_current$SomaScan_max) | Value <= thresholds_current$SomaScan_max))
    )
  
  highlight_disease <- if (protein == "FGR") {
    "Type 2 diabetes"
  } else if (protein == "PTN") {
    c("Acute COVID", "Coronary artery disease")
  }
  
  combined_data_filtered <- combined_data_filtered |> 
    mutate(
      highlight = Disease %in% highlight_disease,
      edge_color = ifelse(highlight, "#000000", "#00000003"),
      point_color = ifelse(highlight, "#000000", "#d3d3d3")
    )
  
  label_data <- combined_data_filtered |> 
    filter(highlight) |> 
    distinct(Disease, Class) |> 
    mutate(
      Disease_factor = factor(Disease, levels = levels(combined_data_filtered$Disease)),
      x_pos = as.numeric(Disease_factor) - 0.5,
      label_color = disease_class[Class]
    )

  boxplot <- ggplot(combined_data_filtered, aes(x = Disease, y = Value, fill = Class)) +
    geom_boxplot(
      aes(alpha = ifelse(highlight, 1, 0.3), color = edge_color),
      outlier.shape = NA,
      linewidth = 0.5
    ) +
    geom_jitter(
      aes(alpha = ifelse(highlight, 0.3, 0.1), color = point_color),
      width = 0.1, size = 0.1
    ) +
    geom_text(
      data = label_data,
      aes(x = x_pos, y = Inf, label = stringr::str_wrap(Disease, width = 15), color = label_color),
      hjust = 1, vjust = 1, fontface = "bold", size = 2, lineheight = 0.9
    ) +
    facet_wrap(~ Technology, ncol = 1, scales = "free_y", 
           labeller = as_labeller(c(
             "Olink" = "Olink (NPX)",
             "SomaScan" = "SomaScan (log2RFU)"
           ))) + 
    labs(y = protein) +
    scale_fill_manual(values = disease_class) +
    scale_color_identity() +
    scale_alpha_identity() +
    scale_y_continuous(breaks = function(limits) {
      step <- ifelse((limits[2] - limits[1]) > 5, 2, 1)
      seq(floor(limits[1]), ceiling(limits[2]), by = step)
    }) +
    theme_hd() +
    theme(
      legend.position = "None",
      strip.text = element_text(size = 6, margin = margin(2,0,2,0, "pt")),
      axis.text = element_text(size = 6),
      axis.text.x = element_blank(),
      axis.ticks.x = element_blank(),
      axis.line.x = element_blank(),
      axis.title = element_text(size = 8),
      axis.title.x = element_blank(),
      axis.ticks.length = unit(4, "pt"),
      plot.margin = margin(t = 5, r = 5, b = 5, l = 5),
      panel.spacing = unit(1.2, "lines")
    )
  
  boxplotwith_colorbar <- boxplot / color_bar +
  plot_layout(heights = c(10, 0.2))
  boxplot_list[[protein]] <- boxplotwith_colorbar
}

wrapped_fgr <- wrap_elements(full = boxplot_list[["FGR"]])
wrapped_ptn <- wrap_elements(full = boxplot_list[["PTN"]])

boxplot_combined <- wrapped_fgr + wrapped_ptn

boxplot_combined[[1]] <- boxplot_combined[[1]] + labs(tag = "D")
boxplot_combined[[2]] <- boxplot_combined[[2]] + labs(tag = "E")

combined_bottom <- scatter_wrapped / boxplot_combined +
  plot_layout(heights = c(length(protein_plots)/2, 1))

top_grob <- patchworkGrob(final_combined_plot)
bottom_grob <- patchworkGrob(combined_bottom)
final_plot <- grid.arrange(
  top_grob,
  bottom_grob,
  heights = c(1, length(protein_plots) + 1)
)

ggsave(
  filename = "results/combined_pair_plots_A4_filt_2.png",
  plot = final_plot,
  width = 21,
  height = 29.7,
  units = "cm"
)
```

```{r}
disease_datasets <- meta |>
  group_by(Disease) |>
  summarise(DAids = list(DAid), .groups = "drop")

diff_exp_proteins_plot <- diff_exp_proteins |>
  mutate(
    sig_Olink = sig_Olink %in% c("significant up", "significant down"),
    sig_SomaScan = sig_SomaScan %in% c("significant up", "significant down"),
    both_significant = sig_Olink & sig_SomaScan & (sig_Olink == sig_SomaScan)
  )

diff_exp_proteins_by_disease <- diff_exp_proteins_plot |>
  group_by(Disease) |>
  summarise(
    olink_only_proteins = list(Assay[sig_Olink & !sig_SomaScan]),
    soma_only_proteins = list(Assay[sig_SomaScan & !sig_Olink]),
    both_proteins = list(Assay[both_significant]),
    non_sig_proteins = list(Assay[!sig_Olink & !sig_SomaScan]),
    .groups = "drop"
  )

correlation_results_disease <- list()

for (i in seq_len(nrow(disease_datasets))) {
  disease_name <- disease_datasets$Disease[i]
  daids <- disease_datasets$DAids[[i]]
  
  olink_filtered <- olink |> filter(DAid %in% daids)
  soma_filtered <- soma |> filter(DAid %in% daids)
  
  diff_proteins <- diff_exp_proteins_by_disease |>
    filter(Disease == disease_name)
  
  olink_only_proteins <- unlist(diff_proteins$olink_only_proteins)
  soma_only_proteins <- unlist(diff_proteins$soma_only_proteins)
  both_proteins <- unlist(diff_proteins$both_proteins)
  non_sig_proteins <- unlist(diff_proteins$non_sig_proteins)
  
  for (category in c("Significant in Olink", "Significant in SomaScan", "Significant in both", "Not significant in both")) {
    if (category == "Significant in Olink") {
      olink_subset <- olink_filtered |> filter(Assay %in% olink_only_proteins)
      soma_subset <- soma_filtered |> filter(Assay %in% olink_only_proteins)
    } else if (category == "Significant in SomaScan") {
      olink_subset <- olink_filtered |> filter(Assay %in% soma_only_proteins)
      soma_subset <- soma_filtered |> filter(Assay %in% soma_only_proteins)
    } else if (category == "Significant in both") {
      olink_subset <- olink_filtered |> filter(Assay %in% both_proteins)
      soma_subset <- soma_filtered |> filter(Assay %in% both_proteins)
    } else if (category == "Not significant in both") {
      olink_subset <- olink_filtered |> filter(Assay %in% non_sig_proteins)
      soma_subset <- soma_filtered |> filter(Assay %in% non_sig_proteins)
    }
    
    correlation_data <- olink_subset |>
      inner_join(soma_subset, by = c("DAid", "Assay")) |>
      group_by(Assay, AptName) |>
      summarise(
        correlation = if (sum(is.finite(NPX) & is.finite(Value)) > 1)
          suppressWarnings(cor(NPX, Value, method = "spearman", use = "complete.obs"))
        else
          NA_real_,
        .groups = "drop"
      ) |>
      mutate(Disease = disease_name, Category = category)
    
    correlation_results_disease[[paste(disease_name, category)]] <- correlation_data
  }
}

summary_stats <- bind_rows(correlation_results_disease) |>
  group_by(Disease, Category) |>
  summarise(
    mean_corr = mean(correlation, na.rm = TRUE),
    sd_corr = sd(correlation, na.rm = TRUE),
    .groups = "drop"
  ) |>
  left_join(meta |> select(Disease, Class) |> distinct(), by = "Disease") |>
  mutate(
    Disease = factor(Disease, levels = rev(levels(combined_data_filtered$Disease))),
    Category = factor(Category, levels = c("Significant in Olink", "Significant in SomaScan", "Significant in both", "Not significant in both"))
  ) |>
  filter(!grepl("BAMSE", Disease) & Disease != "Healthy")

corr_by_disease_plot <- ggplot(summary_stats, aes(x = Disease, y = mean_corr, color = Category)) +
  geom_point(position = position_dodge(width = 0), size = 1.5) +
  scale_color_manual(
    values = c(
      "Significant in Olink" = "#6FC2EE",
      "Significant in SomaScan" = "#D82F88",
      "Significant in both" = "#312F7C",
      "Not significant in both" = "#E5E5E5"
    ),
    name = "Significance"
  ) +
  labs(x = NULL, y = "Mean ρ") +
  ylim(0.1, 0.75) +
  coord_flip() +
  theme_hd() +
  theme(
    legend.position = "none",
    legend.text = element_text(size = 6),
    legend.title = element_text(size = 8, face = "bold"),
    legend.key.size = unit(6, "pt"),
    axis.text = element_text(size = 6),
    axis.text.x = element_text(hjust = 0.5),
    axis.text.y = element_text(hjust = 1),
    axis.title = element_text(size = 8),
    axis.ticks.length = unit(4, "pt"),
    plot.margin = margin(t = 5, r = 5, b = 5, l = 5)
  ) +
  guides(color = guide_legend(nrow = 2, byrow = TRUE))

threshold <- 0.5
below_threshold_global <- correlation |>
  filter(correlation < threshold) |>
  select(Assay, AptName, global_correlation = correlation)

rescue_results_disease <- correlation_by_disease |>
  group_by(Disease) |>
  summarise(
    n_rescued = sum(correlation > threshold & paste(Assay, AptName) %in% paste(below_threshold_global$Assay, below_threshold_global$AptName)),
    .groups = "drop"
  ) |>
  left_join(meta |> select(Disease, Class) |> distinct(), by = "Disease") |>
  mutate(
    Disease = factor(Disease, levels = rev(levels(combined_data_filtered$Disease)))
  ) |>
  filter(!grepl("BAMSE", Disease) & Disease != "Healthy")

rescued_bar_plot <- ggplot(rescue_results_disease, aes(x = Disease, y = n_rescued)) +
  geom_bar(aes(fill = Class), stat = "identity", color = "black") +
  scale_fill_manual(values = disease_class) +
  scale_y_continuous(breaks = c(0, 300), limits = c(0, NA)) +
  labs(x = NULL, y = "# Proteins") +
  coord_flip() +
  theme_hd() +
  theme(
    legend.position = "none",
    axis.text = element_text(size = 6),
    axis.text.x = element_text(hjust = 0.5),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    axis.line.y = element_blank(),
    axis.title = element_text(size = 8),
    axis.ticks.length = unit(4, "pt"),
    plot.margin = margin(t = 5, r = 5, b = 5, l = 0)
  )

corr_by_disease_plot <- corr_by_disease_plot +
  theme(plot.margin = margin(t = 0, r = 5, b = 5, l = 5))

combined_corr_plot <- corr_by_disease_plot + rescued_bar_plot +
  plot_layout(widths = c(1, 0.3)) +
  plot_annotation(tag_levels = list(c("F", "")))

wrapped_fgr <- wrap_elements(full = boxplot_list[["FGR"]])
wrapped_ptn <- wrap_elements(full = boxplot_list[["PTN"]])

boxplot_combined <- wrapped_fgr / wrapped_ptn
boxplot_combined[[1]] <- boxplot_combined[[1]] + labs(tag = "D")
boxplot_combined[[2]] <- boxplot_combined[[2]] + labs(tag = "E")

corr_by_disease_plot <- corr_by_disease_plot + labs(tag = "F")

combined_corr_plot <- corr_by_disease_plot + rescued_bar_plot +
  plot_layout(widths = c(1, 0.3))

bottom_row <- boxplot_combined | combined_corr_plot
bottom_row <- bottom_row + plot_layout(widths = c(3, 1))

combined_bottom <- scatter_wrapped / bottom_row +
  plot_layout(heights = c(length(protein_plots)/2, 2))

top_grob <- patchworkGrob(final_combined_plot)
bottom_grob <- patchworkGrob(combined_bottom)

final_plot <- grid.arrange(
  top_grob,
  bottom_grob,
  heights = c(1, length(protein_plots) + 1)
)

ggsave(
  filename = "results/figure2.png",
  plot = final_plot,
  width = 21,
  height = 29.7,
  units = "cm"
)
```

## Supplementary Figures

```{r}
correlation <- olink |>
  inner_join(soma, by = c("DAid", "Assay")) |>
  group_by(Assay, AptName) |>
  summarise(
    correlation = if (sum(is.finite(NPX) & is.finite(Value)) > 1)
      suppressWarnings(cor(NPX, Value, method = "spearman", use = "complete.obs"))
    else
      NA_real_,
    .groups = "drop"
  ) |> 
  group_by(Assay) |>
  slice_max(order_by = correlation, n = 1, with_ties = FALSE) |>
  ungroup() |> 
  select(Assay, correlation)
```

```{r}
# Get LOD per Assay from Olink
olink_lod <- olink |>
  mutate(above_lod = NPX > LOD) |>
  group_by(Assay) |>
  summarise(
    Olink_LOD = mean(above_lod, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Get eLOD per Assay from SomaScan
soma_elod <- soma |>
  mutate(above_lod = Value > eLOD) |>
  group_by(Assay) |>
  summarise(
    SomaScan_LOD = mean(above_lod, na.rm = TRUE) * 100,
    .groups = "drop"
  )

# Merge LOD and eLOD, add protein tiers and HPA features
features <- olink_lod |>
  left_join(soma_elod, by = "Assay") |>
  left_join(protein_tiers, by = "Assay") |> 
  mutate(Tier = replace_na(as.character(Tier), "Unclassified")) |> 
  left_join(hpa_metadata |> 
      rename(Assay = Gene) |> 
      select(Assay, Ensembl, `Protein class`, `Secretome location`, `Subcellular location`, `RNA tissue specificity`, `RNA tissue distribution`, `RNA single nuclei brain specificity`, `RNA single nuclei brain distribution`, `RNA single cell type specificity`, `RNA single cell type distribution`, `RNA blood cell specificity`, `RNA blood cell distribution`, `RNA cancer specificity`, `RNA cancer distribution`), 
    by = "Assay") |> 
  filter(!is.na(Ensembl)) |> 
  select(-Ensembl) |> 
  mutate(
    across(
      contains("distribution") | contains("specificity"),
      ~replace_na(.x, "Not detected")
    ),
    `Secretome location` = replace_na(`Secretome location`, "Unknown"),
    `Subcellular location` = replace_na(`Subcellular location`, "Unknown")
  ) |> left_join(correlation, by = "Assay")
```

```{r}
# Prepare features
features_rf <- features |>
  select(-Assay) |>  # Assay is the ID
  mutate(
    across(where(is.character), as.factor)
  )

# Multi-hot encode Subcellular location
subcell_mat <- features$`Subcellular location` |>
  str_split(",") |>
  lapply(str_trim) |>
  unique() |>
  unlist() |>
  unique() |>
  sort()

subcell_types <- unique(unlist(str_split(features$`Subcellular location`, ",")))
subcell_types <- str_trim(subcell_types)
subcell_types <- unique(subcell_types[subcell_types != "Unknown"])

subcell_matrix <- sapply(subcell_types, function(loc) {
  str_detect(features$`Subcellular location`, stringr::fixed(loc))
}) * 1
colnames(subcell_matrix) <- paste0("Subcell_", make.names(subcell_types))

# Combine with features
features_rf <- features_rf |>
  select(-`Subcellular location`) |>
  bind_cols(as_tibble(subcell_matrix))

# Split data
set.seed(123)
data_split <- initial_split(features_rf, strata = correlation)
train_data <- training(data_split)
test_data  <- testing(data_split)

# Encode all categorical variables except subcellular
rf_recipe <- recipe(correlation ~ ., data = train_data) |>
  step_dummy(all_nominal_predictors())

rf_spec <- rand_forest(mode = "regression") |>
  set_engine("ranger", importance = "permutation")

rf_wf <- workflow() |>
  add_recipe(rf_recipe) |>
  add_model(rf_spec)

rf_fit <- rf_wf |> fit(data = train_data)

vip_plot <- vip(rf_fit$fit$fit) + theme_hd() + theme(
  axis.text = element_text(size = 6),
  axis.text.x = element_text(hjust = 0.5),
  axis.title = element_text(size = 8),
  axis.ticks.length = unit(4, "pt"),
  plot.margin = margin(t = 5, r = 5, b = 5, l = 5)
)
vip_plot

preds <- predict(rf_fit, test_data) |> bind_cols(test_data)

metrics <- preds |>
  metrics(truth = correlation, estimate = .pred)

metrics
```

### Correlation and other factors

```{r}
correlation_secretome <- correlation |>
  left_join(gene_secretome, by = "Assay") |>
  mutate(secretome_annotation = replace_na(secretome_annotation, "Unknown secreted location")) |>
  mutate(
    secretome_annotation = case_when(
      secretome_annotation %in% c("Actively secreted to blood", "Unknown secreted location", "Intracellular and Membrane") ~ secretome_annotation,
      TRUE ~ "Secreted to other locations"
    )
  )

secretom_corr <- ggplot(correlation_secretome, aes(x = secretome_annotation, y = correlation, fill = secretome_annotation)) +
  geom_violin(trim = FALSE, color = "black", alpha = 0.5) +
  geom_boxplot(width = 0.1, position = position_dodge(width = 0.9), outlier.shape = NA) +
  theme_hd() +
  scale_fill_manual(values = c(
    "Actively secreted to blood" = "#B24F52",
    "Secreted to other locations" = "#B89B74",
    "Intracellular and Membrane" = "#457B9D",
    "Non secreted in blood" = "#7C7C7C"
  )) +
  labs(y = "Spearman Correlation") + 
  ylim(-0.5, 1) + 
  theme(
      legend.position = "none",
      axis.text = element_text(size = 6),
      axis.text.x = element_text(hjust = 0.5),
      axis.title = element_text(size = 8),
      axis.title.x = element_blank(),
      axis.ticks.length = unit(4, "pt"),
      plot.margin = margin(t = 5, r = 5, b = 5, l = 5),
    )
```

### Protein Tiers

```{r}
correlation_proteintiers <- correlation |>
  left_join(protein_tiers, by = "Assay") |> 
  mutate(Tier = ifelse(is.na(Tier), "Unclassified", Tier))

tier_corr <- ggplot(correlation_proteintiers, aes(x = Tier, y = correlation, fill = Tier)) +
  geom_violin(trim = FALSE, color = "black", alpha = 0.5) +
  geom_boxplot(width = 0.1, position = position_dodge(width = 0.9), outlier.shape = NA) +
  theme_hd() +
  ylim(-0.5, 1) +  
  scale_fill_brewer(palette = 3, direction = -1) +
  labs(
    x = "Protein Tiers (based on pQTLs)",
    y = "Spearman Correlation"
  ) + 
  theme(
      legend.position = "none",
      axis.text = element_text(size = 6),
      axis.text.x = element_text(hjust = 0.5),
      axis.title = element_text(size = 8),
      axis.ticks.length = unit(4, "pt"),
      plot.margin = margin(t = 5, r = 5, b = 5, l = 5),
    )
```

### Olink LOD

```{r}
bins <- c(0, 0.25, 0.5, 0.75, 1)

below_olink_LOD <- olink |>
  group_by(Assay) |>
  summarise(
    prop_below_olink_LOD = mean(NPX < LOD, na.rm = TRUE),
    .groups = "drop"
  )

below_soma_by_assay <- soma |>
  group_by(Assay) |>
  summarise(
    prop_below_soma_LOD = mean(Value < eLOD, na.rm = TRUE),
    .groups = "drop"
  )

assays_to_keep <- below_soma_by_assay |>
  filter(is.na(prop_below_soma_LOD) | prop_below_soma_LOD <= 0.25) |>
  pull(Assay)

correlation_binned <- correlation |>
  inner_join(below_olink_LOD, by = "Assay") |>
  filter(Assay %in% assays_to_keep) |>
  mutate(
    bin_olink = cut(prop_below_olink_LOD, breaks = bins, include.lowest = TRUE),
    bin_olink = factor(bin_olink, levels = c("[0,0.25]", "(0.25,0.5]", "(0.5,0.75]", "(0.75,1]"))
  )

bin_counts <- correlation_binned |>
  group_by(bin_olink) |>
  summarise(
    n = n(),
    y = ifelse(all(is.na(correlation)), NA_real_, max(correlation, na.rm = TRUE)),
    .groups = "drop"
  ) |>
  mutate(
    label = paste0("n = ", n),
    y = y + 0.05
  )

lod_corr <- ggplot(correlation_binned, aes(x = bin_olink, y = correlation, fill = bin_olink)) +
  geom_violin(trim = FALSE, color = "black") +
  geom_boxplot(width = 0.1, position = position_dodge(width = 0.9), outlier.shape = NA) +
  scale_fill_brewer(palette = 1, direction = -1) +
  theme_hd() +
  ylim(-0.5, 1) + 
  labs(x = "Proportion of samples below Olink LOD") +
  theme(
      legend.position = "none",
      axis.text = element_text(size = 6),
      axis.text.x = element_text(hjust = 0.5),
      axis.title = element_text(size = 8),
      axis.title.y = element_blank(),
      axis.line.y = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks.y = element_blank(),
      axis.ticks.length = unit(4, "pt"),
      plot.margin = margin(t = 5, r = 5, b = 5, l = 5),
    )
```

```{r}
top_grob <- wrap_elements(full = vip_plot) 
bottom_grid <- secretom_corr / (tier_corr + lod_corr) + plot_layout(heights = c(1.0, 0.9))
merged_plot <- top_grob / bottom_grid + plot_layout(heights = c(0.7, 1)) + plot_annotation(tag_levels = "A")

ggsave(
  filename = "results/correlation_additional_factors.png",
  plot = merged_plot,
  width = 21,
  height = 21, 
  units = "cm"
)
```